target==cast_target[3]) %>%
dplyr::select(names(prob.dat)[grep("quantile_",names(prob.dat))], target) %>%
unlist()
prob =  max(round(max(as.numeric(substr(names(quantile[2:23]),10,14))[which(as.numeric(quantile)<observed.deaths)], na.rm = T),digits=3),0)
prob=ifelse(is.na(prob),0,prob)
prob=ifelse(observed.deaths==0,0,prob)
prob=ifelse(observed.deaths<0,NA,prob)
return(prob)
})
Prob.Increase_4 = map_dbl(.x=Locations, .f = function(.x){
observed.deaths=
filter(obs_data1,
location_name==.x) %>%
arrange(wk_end_date) %>%
tail(1) %>%
dplyr::select(value) %>% unlist()
quantile= filter(prob.dat,
# model== ensemble_for_display ,
location_name==.x,
target==cast_target[4]) %>%
dplyr::select(names(prob.dat)[grep("quantile_",names(prob.dat))], target) %>%
unlist()
# prob =  round(1-min(as.numeric(substr(names(quantile),10,14))[which((quantile)>observed.cases)]),digits=3)
prob =  max(round(1-min(as.numeric(substr(names(quantile[2:23]),10,14))[which(as.numeric(quantile)>observed.deaths)], na.rm = T),digits=3),0)
prob=ifelse(is.na(prob),0,prob)
prob=ifelse(observed.deaths==0,NA,prob)
prob=ifelse(observed.deaths<0,NA,prob)
return(prob)
})
Prob.Decrease_4 = map_dbl(.x=Locations, .f = function(.x){
observed.deaths=
filter(obs_data1,
location_name==.x) %>%
arrange(wk_end_date) %>%
tail(1) %>%
dplyr::select(value) %>% unlist()
quantile= filter(prob.dat,
# model== ensemble_for_display ,
location_name==.x,
target==cast_target[4]) %>%
dplyr::select(names(prob.dat)[grep("quantile_",names(prob.dat))], target) %>%
unlist()
prob =  max(round(max(as.numeric(substr(names(quantile[2:23]),10,14))[which(as.numeric(quantile)<observed.deaths)], na.rm = T),digits=3),0)
prob=ifelse(is.na(prob),0,prob)
prob=ifelse(observed.deaths==0,0,prob)
prob=ifelse(observed.deaths<0,NA,prob)
return(prob)
})
change <-
data.frame(Locations,Prob.Increase_1,Prob.Decrease_1,Prob.Increase_2,Prob.Decrease_2,Prob.Increase_3,Prob.Decrease_3,Prob.Increase_4,Prob.Decrease_4,
num_horizons.wk.point.change =
map_dbl(.x = Locations,
.f = function(.x){
last_obs = filter(obs_data1, wk_end_date == max(wk_end_date)) %>% dplyr::select(location_name, value)
val = last_obs$value[which(last_obs$location_name==.x)[1]]
df=filter(dat1, location_name==.x, target == cast_target[num_horizons])
return(df$quantile_0.5 - val)
})#,
# Last.obs.in1.wk.50.PI =
#   map_chr(.x = "Locations", .f = function(.x){
#     last_obs = filter(obs_data1, wk_end_date == max(wk_end_date)) %>% dplyr::select(location_name, value)
#     val = last_obs$value[which(last_obs$location_name==.x)]
#     df=filter(dat1, location_name==.x, target == "4 wk inc flu hosp")#cast_target[num_horizons])
#     interval = seq(df$quantile_0.25, df$quantile_0.75,1)
#     if(!val %in% interval){return("No (flagged)")}
#     else {return("Yes")}
#   })
)
change[is.na(change)] <- 0
change <- change %>%
mutate(Classification =ifelse(Prob.Decrease_4 >=0.75, #& abs(num_horizons.wk.point.change)>10,
"Decrease",NA),
Classification = ifelse((Prob.Increase_4<0.75 & Prob.Decrease_4 < 0.75),
"Uncertain", Classification),
#Classification = ifelse((Prob.Increase_4>=0.75 | Prob.Decrease_4 >= 0.75),# & abs(num_horizons.wk.point.change)<= 10,
#                      "Uncertain", Classification), #paste0("Uncertain (reclassified, ", num_horizons, "-wk point change <= 10)"), Classification),
Classification = ifelse(Prob.Increase_4>=0.75, #& abs(num_horizons.wk.point.change)>10,
"Increase", Classification)) %>%
arrange(desc(Prob.Increase_4))
change.dat1 <- change
change.dat1$Classification_color <- ifelse(change.dat1$Classification == "Uncertain", "#444444", ifelse(change.dat1$Classification == "Increase", "#D55E00",
ifelse(change.dat1$Classification == "Decrease", "#0072B2", NA)))
#change.dat1 <- change.dat1[-c(54),]
#change.dat1$target_end_date <- as.POSIXct("2021-11-12", format = "%Y-%m-%d")
#usstat <- readRDS("C:/Users/rpe5/COVIDashboard stuff/usgeo.RDS")
usstat <- read_sf("usstateandterr.shp")
#usstat <- tigris::states(class = "sf")
#change.dat <- merge(usstat, change.dat1[,c(1:5, 8:10)], by.y = "location_name", by.x = "NAME")
change.dat <- merge(usstat, change.dat1, by.y = "Locations", by.x = "NAME")
#change.dat <- change.dat[-c(2),]
#change.dat$NAME
#change.mets1 <- change.dat1[, c(1:3, 8:10)]
change.mets1 <- change.dat1
change.mets1$location_name <- change.mets1$Locations
#change.mets <- change.mets1 %>%
#  pivot_longer(cols = c(-location_name), names_to = "Probability") %>%
#  pivot_wider(names_from = c(location_name))
#forcts <- all.dat %>%
#  filter(target_end_date == max(target_end_date)) %>%
#  filter(model == "Ensemble")
forcts <- dat1
Ens <- dat1
#Ens <- all.dat %>%
#  filter(model == "Ensemble")
#mods <- read_csv(paste0(rundate, "-all-hospitalizations-model-data.csv")) %>%
#  filter(model!="Ensemble") %>%
#  pull(model) %>%
#  unique
#obs_data <- read.csv(paste0(shpt, max(inclusion_dates),"/Other output/", max(inclusion_dates), "-", "reported-hosps-data.csv"))
ensemble_for_display <- "FluSight-Ensemble"
display_targets <- cast_target
display_dates <- c(as.Date(forecast_date) - seq(1, 25))
all_mod_dat <- as.data.frame(rbind(dat1, forecast_data1)) %>% dplyr::select(target, target_end_date, forecast_date, model, location_name, quantile_0.025, quantile_0.25, quantile_0.5, quantile_0.75, quantile_0.975)
source("C:/Users/rpe5/COVIDashboard stuff/Weekly Data/Model names and colors.R")
#source(paste0(ncov19path, "Plotting functions.R"))
#source("Dashboard Functions.R")
forcts_national <- forcts %>% filter(location_name == "National") %>% dplyr::select(target, target_end_date, forecast_date, model, location_name, quantile_0.025, quantile_0.25, quantile_0.5, quantile_0.75, quantile_0.975) %>% as.data.frame()
modelnames <- unique(forecast_data$model)
teamnames <- model_team_names[modelnames]
mandtnames <- as.data.frame(cbind(modelnames, teamnames))
mandtnames %>% knitr::kable(col.names = c("Model Name", "Team Name"), row.names = F)
filedirec <- paste0("C:/Users/",userid,"/COVIDashboard stuff/")
recent_subs <- as.Date(as.Date(forecast_date) - c(0, 7, 7*2, 7*3, 7*4, 7*5)) #5 weeks of most recent submitted forecasts, where last week's forecast=0, + this week's forecast
### Change indicators
change.meds <- change %>% rename(location_name = Locations)
## Plots
## set colors
#source(paste0(ncov19path, "Plotting functions.R"))
#source(paste0(ncov19path, "Model names and colors.R"))
source("C:/Users/rpe5/COVIDashboard stuff/Weekly Data/Model names and colors.R")
#N
options(scipen=5)
## Rename locations based on change metrics
decrease <-change.meds[which(change.meds$Classification=="Decrease"),]
decrease.plot <-as.vector(decrease$location_name)
increase <-change.meds[which(change.meds$Classification=="Increase"),]
increase.plot <-as.vector(increase$location_name)
flagged <-change.meds %>%
mutate(Classification =ifelse(Prob.Decrease_4 >=0.9,"Decrease",NA),
Classification = ifelse(Prob.Decrease_4>=0.75 & Prob.Decrease_4 <0.9, "Decrease", Classification),
Classification = ifelse(Prob.Increase_4<0.75 & Prob.Decrease_4 <0.75,"Uncertain", Classification),
Classification = ifelse(Prob.Increase_4>=0.75 & Prob.Increase_4 <0.9,"Increase", Classification),
Classification = ifelse(Prob.Increase_4 >=0.9,"Increase", Classification)
) %>%
filter(Classification!="Uncertain") %>%
mutate(location_name=ifelse(location_name %in% decrease$location_name, paste0(location_name,"*", sep=""), location_name),
location_name=ifelse(location_name %in% increase$location_name, paste0(location_name,"**", sep=""), location_name))
flagged <-as.vector(flagged$location_name)
plot_retro_flu <- function(modelname) {
pdf(paste0(filedirec,"Retro Plots/",
"Hospital_Flu_Forecast_Retrospective_Plots_",modelname,"_", forecast_date,".pdf"),
width=11, height=7.5, paper='USr')
par(mfrow=c(2, 3),
mar=c(1.5, 2, 2, 2.5), oma=c(3, 2, 2, 2),
mgp=c(0.5, 0.3, 0), tck=-0.01)
for (i in 1:length(all_locations)) {
this_location <-all_locations[i]
first = 1
for(j in 1:length(submission_date))
{
this_submission_date = submission_date[j]
fcasts <- filter(dat.plot,
#model=="FluSight-Ensemble",
location_name == this_location,
forecast_date == this_submission_date)
obs <- filter(obs_data,
location_name == this_location,
date %in%
seq(
min(obs_data$date),
max(c(max(obs_data$date),
max(as.Date(fcasts$target_end_date))), na.rm =T),
1)) # 7))
if(nrow(obs) == 0) {
print(this_location)
next
}
if(nrow(fcasts) == 0) {
print(this_location)
next
}
print(this_location)
plot(dplyr::select(obs, date, report),
xlim=c(as.Date("2021-10-01"), max(as.Date(dat.plot$target_end_date))),#c(min(obs$date), max(as.Date(dat.plot$target_end_date))),
ylim = c(0, max(obs$report,
filter(dat.plot,
location_name == this_location,
target_end_date == max(dat.plot$target_end_date))$quantile_0.975,
na.rm=T)),
type='n',
#pch=16, col='black',
axes=F, xlab='', ylab='Weekly incident hospitalizations', cex=0.50,
main = paste0("Forecast Submitted ", this_submission_date))
if(first == 1)
{
mtext(#this_location, 3, 1.5, adj=0, font=2, cex=1.5)
ifelse(this_location %in% flagged,
paste(this_location, "(difference flag & predicated change)"), this_location),
3, 1.5, adj=0, font=2, cex=1.5)
first = 0
}
add_x_grid(c(obs$date, as.Date(dat.plot$target_end_date)))
add_y_grid(y = c(0, 2*filter(dat.plot, location_name==this_location)$quantile_0.975),this_n = 100)
# add_y_grid(c(0, 2*filter(dat.plot, location_name==this_location)$quantile_0.975))
add_x_axis(c(obs$date, max(obs$date) + seq(7,7*4,7)))
add_y_axis(y = c(0, 2*filter(dat.plot, location_name==this_location)$quantile_0.975),this_n = 100)
# add_y_axis(c(0, 2*filter(dat.plot, location_name==this_location)$quantile_0.975))
lines(obs %>% dplyr::select(date, report) %>%
filter(date < Sys.Date()-7))
points(obs %>% dplyr::select(date, report) %>%
filter(date < Sys.Date()-7),
col="black", pch=16, cex=1.3)
points(obs %>% dplyr::select(date, report) %>%
filter(date > Sys.Date()-7),
col=adjustcolor("black", 0.45), pch=16)
for (this_model in unique(fcasts$model)) {
lines(filter(fcasts, model == this_model) %>%
dplyr::select(target_end_date, quantile_0.5),
col=adjustcolor(model_colors[this_model], 0.50))
points(filter(fcasts, model == this_model) %>%
dplyr::select(target_end_date, quantile_0.5),
col=adjustcolor(model_colors[this_model], 0.50), pch=16)
plot_bands(filter(fcasts, model == this_model) %>%
dplyr::select(target_end_date, quantile_0.25, quantile_0.75),
col=adjustcolor(model_colors[this_model], 0.35), border=NA)
plot_bands(filter(fcasts, model == this_model) %>%
dplyr::select(target_end_date, quantile_0.025, quantile_0.975),
col=adjustcolor(model_colors[this_model], 0.25), border=NA)
}
abline(v=this_submission_date, lwd=1.5, lty=2)
legend('topleft',
legend=c("Reported", unique(fcasts$model)),
fill=c("black", model_colors[unique(fcasts$model)]),
ncol=ifelse(length(unique(fcasts$model))>6,2,1),
# border=NA,
bty='n', cex=0.75)
legend('bottomright',
legend="Inner Bands: 50% Prediction Intervals\nOuter Bands: 95% Prediction Intervals",
cex=0.75, #border=NA,
bty='n')
if (this_location %in% decrease.plot) {
mtext("*New weekly confirmed flu hospital admissions may decrease in this location over the next four weeks. For these locations, the ensemble forecast indicates a median daily probability \nof 0.75 or greater that fewer hospital admissions will be reported in the last seven days of the forecast than the median in the last seven days of reported data.",
1, 2, adj=0, outer=T, cex=0.65)}
if (this_location %in% increase.plot) {
mtext("**New weekly confirmed flu hospital admissions may increase in this location over the next four weeks. For these locations, the ensemble forecast indicates a median daily probability \nof 0.75 or greater that more hospital admissions will be reported in the last seven days of the forecast than the median in the last seven days of reported data.",
1, 2, adj=0, outer=T, cex=0.65)}
}
while(!par('page')) plot.new()
}
dev.off()
}
modelnames <- c(modelnames, "Flusight-ensemble")
for (i in 1:length(modelnames)){
model_name <- modelnames[i]
#all_dat <- rd_in_ensemble()
all_dat <- rd_in_model(model_name)
all_dat <-all_dat %>%
left_join(., location_names, by="location") %>%
mutate(location_name = ifelse(location == 'US', 'National', location_name)) %>%
mutate(model=model_name) %>%
dplyr::select(-location)
all_dat <- unique(all_dat)
dat.plot <- all_dat %>%
mutate(value = case_when(quantile==0.5 ~ round(value),
quantile<0.5 ~ floor(value),
quantile>0.5 ~ ceiling(value),
type=='point' ~ round(value))) %>%
pivot_wider(names_from = c(type, quantile), values_from=value) %>%
#rename(point = point_NA) %>%
filter(forecast_date >= recent_subs[5]) %>%
arrange(target_end_date, location_name)
submission_date <-unique(as.Date(dat.plot$forecast_date))
dat.plot <- dat.plot %>%
mutate(location_name=ifelse(location_name %in% decrease$location_name, paste0(location_name,"*", sep=""), location_name),
location_name=ifelse(location_name %in% increase$location_name, paste0(location_name,"**", sep=""), location_name)) %>% #,
arrange(target_end_date, location_name)
## Set up location vectors for labeling
all_locations <- c(grep("National", dat.plot$location_name, value = T)[1],
unique(dat.plot$location_name[dat.plot$location_name
!= grep("National", dat.plot$location_name, value = T)[1]])) #BE SURE TO UPDATE 'NATIONAL' BASED on CLASSIFICATION
increase.plot <-grep("**", all_locations, value=TRUE, fixed=TRUE) #Added vector for footnote
decrease.plot <-grep("*", all_locations, value=TRUE, fixed=TRUE) #Added vector for footnote
decrease.plot <-decrease.plot[which(!decrease.plot %in% increase.plot)]
plot_retro_flu(model_name)
}
for (i in 1:length(modelnames)){
model_name <- modelnames[i]
#all_dat <- rd_in_ensemble()
all_dat <- rd_in_model(model_name)
all_dat <-all_dat %>%
left_join(., location_names, by="location") %>%
mutate(location_name = ifelse(location == 'US', 'National', location_name)) %>%
mutate(model=model_name) %>%
dplyr::select(-location)
all_dat <- unique(all_dat)
dat.plot <- all_dat %>%
mutate(value = case_when(quantile==0.5 ~ round(value),
quantile<0.5 ~ floor(value),
quantile>0.5 ~ ceiling(value),
type=='point' ~ round(value))) %>%
pivot_wider(names_from = c(type, quantile), values_from=value) %>%
#rename(point = point_NA) %>%
filter(forecast_date >= recent_subs[5]) %>%
arrange(target_end_date, location_name)
submission_date <-unique(as.Date(dat.plot$forecast_date))
dat.plot <- dat.plot %>%
mutate(location_name=ifelse(location_name %in% decrease$location_name, paste0(location_name,"*", sep=""), location_name),
location_name=ifelse(location_name %in% increase$location_name, paste0(location_name,"**", sep=""), location_name)) %>% #,
arrange(target_end_date, location_name)
obs_data <- obs_data1 %>%
rename(date = wk_end_date, report = value) %>%
mutate(location_name=ifelse(location_name %in% decrease$location_name, paste0(location_name,"*", sep=""), location_name),
location_name=ifelse(location_name %in% increase$location_name, paste0(location_name,"**", sep=""), location_name)) %>% #,
arrange(date, location_name)
## Set up location vectors for labeling
all_locations <- c(grep("National", dat.plot$location_name, value = T)[1],
unique(dat.plot$location_name[dat.plot$location_name
!= grep("National", dat.plot$location_name, value = T)[1]])) #BE SURE TO UPDATE 'NATIONAL' BASED on CLASSIFICATION
increase.plot <-grep("**", all_locations, value=TRUE, fixed=TRUE) #Added vector for footnote
decrease.plot <-grep("*", all_locations, value=TRUE, fixed=TRUE) #Added vector for footnote
decrease.plot <-decrease.plot[which(!decrease.plot %in% increase.plot)]
plot_retro_flu(model_name)
}
knitr::opts_chunk$set(echo = TRUE)
#source("C:/Users/rpe5/Desktop/GitHub/nCov-2019/Forecast visualization/Model names and colors.R")
library("png")
# Set date of ensemble
forecast_date <- "2022-04-18"
userid = "rpe5"
hubpath = paste0("C:/Users/",userid,"/OneDrive - CDC/Projects/covid19-forecast-hub")
#Forecasting.Folder.Location =  "CDC/EPI TF-COVID19 - Modeling/Forecasting"  #
#Forecasting.Folder.Location =  "CDC/EPI TF-COVID19 - Forecasting"  #
#hubpath = paste0("C:/Users/",CDCid,"/Desktop/GitHub/covid19-forecast-hub")
filedirec <- paste0("C:/Users/",userid,"/COVIDashboard stuff/")
# Directory where all forecast files are stored
# Set to this week's directory
#setwd(paste0(filedirec,rundate,"/"))
library(readxl)
library(tidyverse)
library(viridis)
mets <- read.csv(paste0("C:/Users/",userid,"/COVIDashboard stuff/Weekly Data/change_metrics-", forecast_date,".csv")) ##this needs to be changed to the correct file name for deaths
mods <- read.csv(paste0("C:/Users/",userid,"/COVIDashboard stuff/Weekly Data/ensemble_data-", forecast_date,".csv"))  %>% mutate(target_end_date = as.Date(target_end_date))
forc_dat <- read.csv(paste0("C:/Users/",userid,"/COVIDashboard stuff/Weekly Data/forecast_data-", forecast_date,".csv"))  %>% mutate(target_end_date = as.Date(target_end_date))
forcts <- mods %>%
filter(target_end_date == max(as.Date(target_end_date)) & model == "FluSight-Ensemble" & location_name == "National") %>%
mutate(target_end_date=as.Date(target_end_date))
modsub <- forc_dat %>%
filter(model != "FluSight-Ensemble") %>%
mutate(inc = case_when(grepl("inc", target) ~ 1,
TRUE ~ 0),
cum = case_when(grepl("cum", target) ~ 1,
TRUE ~ 0)) %>%
group_by(model) %>%
summarise(inc = max(inc),
cum = max(cum)) %>%
mutate(both = case_when(inc == 1 & cum == 1 ~ 1,
TRUE ~ 0))
options(scipen=999)
select=dplyr::select
## get truth data
source(paste0(hubpath, "/code/processing-fxns/get_next_saturday.R"))
obs_data1 <- read_csv(paste0("C:/Users/",userid,"/COVIDashboard stuff/Weekly Data/obs_data-", forecast_date,".csv")) %>%
mutate(date = as.Date(wk_end_date, "%m/%d/%y"))
obs_data <- obs_data1 %>%
dplyr::select(date) %>%
distinct() %>%
filter(date %in% c(get_next_saturday(forecast_date) + seq(0, -70, by=-7)))
forcts_ <- mods %>% filter(location_name == "National")
### Set up plots
NatName=unique(forc_dat$location_name)[grep("National",unique(forc_dat$location_name))]
all_locations <- c(NatName,
sort(unique(forc_dat$location_name[forc_dat$location_name != NatName])))
all_locations= all_locations[which(all_locations %in% unique(obs_data1$location_name))]
increase.plot <-grep("**", all_locations, value=TRUE, fixed=TRUE) #Added vector for footnote
decrease.plot <-grep("*", all_locations, value=TRUE, fixed=TRUE) #Added vector for footnote
decrease.plot=decrease.plot[which(!decrease.plot %in% increase.plot)]
cdc_logo <- readPNG(paste0(filedirec, "HHS-CDCBadge.png"))
source(paste0(filedirec,"Weekly Data/Model names and colors.R"), local = knitr::knit_global())
source(paste0(filedirec, "Dashboard Functions.R"), local = knitr::knit_global())
plot_all_both()
source(paste0(filedirec, "Dashboard Functions.R"), local = knitr::knit_global())
plot_all_both()
plot_us_inc()
setwd("C:/Users/rpe5/Desktop/GitHub/Flusight-baseline")
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
#devtools::install_github("reichlab/simplets")
source("fit_baseline_one_location.R")
library(purrr)
library(dplyr)
library(readr)
library(tidyr)
library(lubridate)
library(ggplot2)
library(ggforce)
library(covidHubUtils)
library(simplets)
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
#devtools::install_github("reichlab/simplets")
source("fit_baseline_one_location.R")
# Set locations and quantiles
required_quantiles <-
c(0.01, 0.025, seq(0.05, 0.95, by = 0.05), 0.975, 0.99)
required_locations <-
readr::read_csv(file = "https://raw.githubusercontent.com/cdcepi/Flusight-forecast-data/master/data-locations/locations.csv") %>%
dplyr::select("location", "abbreviation")
# The reference_date is the date of the Saturday relative to which week-ahead targets are defined.
# The forecast_date is the Monday of forecast creation.
# The forecast creation date is set to a Monday,
# even if we are delayed and create it Tuesday morning.
reference_date <- lubridate::floor_date(Sys.Date(), unit = "week") - 1
forecast_date <- as.character(reference_date + 2)
# Load data
data <- readr::read_csv("https://raw.githubusercontent.com/cdcepi/Flusight-forecast-data/master/data-truth/truth-Incident%20Hospitalizations.csv") %>%
dplyr::filter(date >= "2021-12-04") %>%
dplyr::arrange(location, date)
location_number <- nrow(required_locations)
# fit baseline models
quantile_forecasts <-
purrr::map_dfr(
required_locations$location,
function(loc) {
print(loc)
location_data <- data %>%
dplyr::filter(location == loc)
location_results <-
fit_baseline_one_location(
reference_date = reference_date,
location_data = location_data,
transformation = "none",
symmetrize = TRUE,
window_size = nrow(data),
taus = required_quantiles
)
return(location_results)
}) %>%
dplyr::select(-model)
if (!dir.exists("weekly-submission/forecasts/Flusight-baseline/")) {
dir.create("weekly-submission/forecasts/Flusight-baseline/",
recursive = TRUE)
}
if (!dir.exists("weekly-submission/plots/Flusight-baseline/")) {
dir.create("weekly-submission/plots/Flusight-baseline/",
recursive = TRUE)
}
base_file <- paste0("/Flusight-baseline/", forecast_date, "-Flusight-baseline")
results_path <- paste0("weekly-submission/forecasts", base_file, ".csv")
plot_path <- paste0("weekly-submission/plots", base_file, ".pdf")
# write forecast submission file
write.csv(quantile_forecasts, file = results_path, row.names = FALSE)
# plot
f <- covidHubUtils::load_forecasts_repo(
file_path = paste0('weekly-submission/forecasts/'),
models = 'Flusight-baseline',
forecast_dates = forecast_date,
locations = NULL,
types = NULL,
targets = NULL,
hub = "FluSight",
verbose = TRUE
)
p <-
covidHubUtils::plot_forecasts(
forecast_data = f,
facet = "~location",
hub = "FluSight",
truth_source = "HealthData",
subtitle = "none",
title = "none",
show_caption = FALSE,
plot = FALSE
) +
scale_x_date(
breaks = "1 month",
date_labels = "%b-%y",
limits = as.Date(c(
reference_date - (7 * 32), reference_date + 28
), format = "%b-%y")
) +
theme(
legend.position = "bottom",
legend.direction = "vertical",
legend.text = element_text(size = 8),
legend.title = element_text(size = 8),
axis.text.x = element_text(angle = 90),
axis.title.x = element_blank()
) +
ggforce::facet_wrap_paginate(
~ location,
scales = "free",
ncol = 2,
nrow = 3,
page = 1
)
n <- n_pages(p)
pdf(
plot_path,
paper = 'A4',
width = 205 / 25,
height = 270 / 25
)
for (i in 1:n) {
suppressWarnings(print(
p + ggforce::facet_wrap_paginate(
~ location,
scales = "free",
ncol = 2,
nrow = 3,
page = i
)
))
}
dev.off()
